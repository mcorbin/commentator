# Commentator

A commenting system for your blog. Comments are stored on any S3-compatible store.

Project announcement (in french): https://mcorbin.fr/posts/2020-11-11-commentator/

## Features

Commentator is a new project (it may have bugs, and I plan to add new features and improve existing ones) but already has some cool features, and I already use it for my personal blog:

- [x] Everytime a comment is added, an event is published in a file also stored on S3
- [x] An easy-to-use API to manage comments and events. Some API calls (to manage comments and events) are restricted to admin.
- [x] Comments approval.
- [x] Rate limiting.
- [x] In memory cache for comments (only invalidated when a change occurs) to avoid having to hit S3 too much and to improve performances.
- [x] A "challenge" system to avoid spams.
- [x] Metrics in Prometheus format

## How it works

Comments are stored on S3. Commentator manages a file stored on S3 per article. This file contains the comments for the article. Comments are stored as json.

A file named `events.json` is also managed by Commentator. Everytime a comment is added by an user, a new event is added in this file.

![Commentator architecture](doc/commentator_schema.jpg?raw=true)

Commentator exposes an API to manage comments (add, list, approve, or delete them) and events (list and delete them).

### Why store things on S3

Almost all languages can interact with S3. There is also tons of tooling and CLI (s3cmd, minio...) to manage resources on S3.
By storing comments and events as json on files stored on S3, Commentator allows you to write your own tooling to manage them (even if the Commentator API may me enough for a lot of users).

## Comments approval

As explained before, comments should be approved before being visible. You can also configure Cabourotte to approve all comments by default.

## Rate limiting

An user can only publish a comment every 10 min. The rate limiter uses the IP address of the client to work and first checks the `x-forwarded-for` request header and then the request source IP.

## Challenges

Users should solve a "challenge" in order to publish a comment. Challenges are configured in the Cabourotte configuration. You can write your own challenges and even programmatically generate them (it's what I did for my personal blog).

For example, here are two challenges from a Commentator configuration file (Commentator uses [EDN](https://github.com/edn-format/edn) for its configuration. You don't know EDN ? Don't worry, it's not more difficult than json)

```clojure

:challenges {:c1 {:question "1 + 4 = ?"
                  :answer "5"}
             :c2 {:question "What is the name of this famous French sausage, a classic of the Cuisine de Lyon and Troyes, made with pork or veal intestines ?"
                  :answer "Andouillette"}}
```

I have defined here two challenges. Each challenge have a name (`:c1` or `:c2` here, which are keys of the `:challenges` map) a question, and an answer.
As you can see, the questions and answers content are free. It allows you to have unique challenges which can be programmatically generated.

I will work in the future on a better challenge system, where challenges cannot be reused, or be dynamically generated by Commentator itself.

## Configuration


```clojure
{;; http server configuration. You can also specify :key, :cert and :cacert for
 ;; mTLS authentication
 :http {:host "127.0.0.1"
        :port 8787}
 ;; the token use for admin calls (basic auth, check the API examples)
 :admin {:token #secret "my-super-token"}
 ;; S3 configuration. Should work on any s3 compatible store (I use the Exoscale one for my personal blog)
 :store {:access-key #secret #env ACCESS_KEY
         :secret-key #secret #env SECRET_KEY
         :endpoint "https://sos-ch-gva-2.exo.io"
         :bucket "mcorbin.fr.test.comment"}
 :comment {:auto-approve false ;; auto approve or not comments
           ;; A list of allowed articles. Only API calls targeting articles in
           ;; this list are allowed.
           :allowed-articles ["foo"
                              "bar"]}
 ;; logger configuration, supports everything described in https://github.com/pyr/unilog
 :logging {:level "info"
           :console {:encoder "json"}
           :overrides {:org.eclipse.jetty "info"
                       :org.apache.http "error"}}
;; Prometheus configuration (optional)
 :prometheus {:host "127.0.0.1"
              :port 8788}

 ;; your challenges
 :challenges {:c1 {:question "1 + 4 = ?"
                   :answer "5"}
              :c2 {:question "1 + 9 = ?"
                   :answer "10"}}}
```

Commentator uses [Aero](https://github.com/juxt/aero) to read the configuration. You have several tag literals availables, for example::

- `#env` to read a value from an environment variable
- `#secret` should be used for some keys. it's a special type used internally to prevent silly mistakes like log a secret.

You can check the [Aero](https://github.com/juxt/aero) README which list more tag literals.

## Run it

You have 2 solutions.

### Run the jar

- Download (or build using `lein uberjar`) the Commentator jar file provided in `Releases` on Github. I develop and test things on Java 11.
- Set the `COMMENTATOR_CONFIGURATION` env var to the path of your Commentator configuration file.
- `java -jar commentator.jar`

A systemd unit file with some defaults is provided in `doc/commentator.service`.

### Build and run the Docker image

A Dockerfile is available at the root of the repository. It will build Commentator and produce an image to run it.

## Public API

These API calls do not need authentication. They should be used to integrate Commentator in your blog.

In these examples which are using curl, Commentator is running on `http://localhost:8787`.

### Add comment

Add a new comment.
Each comment has an author, its content, a challenge name (which should be defiend in your configuration) and the challenge answer provided by the user (if the answer is wrong, an error is returned).

`<articles-name>` should be an article listed in `:allowed-articles`. It means your frontend integration for Commentator should send requests with the right article name depending of the article being commented.

```
curl -X POST --header "Content-Type: application/json" --data \ '{"author":"mcorbin","content":"My comment","challenge":"c1","answer":"5"}' \
http://localhost:8787/api/v1/comment/<articles-name>/

{"message": "Comment added"}
```

### List comments for an article

Only approved comments are returned.

```
curl http://localhost:8787/api/v1/comment/<article-name>

[
  {
    "content": "hello !",
    "author": "mcorbin",
    "id": "c528935d-4478-4cd8-8cdd-db9acb311dcb",
    "approved": true,
    "timestamp": 1605221410457
  }
]
```

#### Get a random challenge

This call can be used to get a random challenge from the configuration. As explained before, users should provide a challenge name and the associated answer to be able to add a comment. Your frontend should retrieve a random challenge and asks to users the answer.

```
curl http://localhost:8787/api/v1/challenge

{
  "name": "3a504794-158e-42c9-89e9-c60dac2ce26a",
  "question": "what is the result of: 7  -  0"
}
```

## Admin API

This API is restricted. You should pass to the `Authorization` header the token defined in the Commentator configuration.

### List events

```
curl -H "Authorization: OIOzkfiZzrzrIIejj" \
http://localhost:8787/api/admin/event

[
  {
    "timestamp": 1607185788030,
    "id": "91a84d70-3951-4144-b3a8-12c70c087d2b",
    "article": "2020-12-04-pull-push",
    "message": "New comment 4c5216d5-6852-45f3-abd1-d25e6f63628c on article 2020-12-04-pull-push",
    "comment-id": "4c5216d5-6852-45f3-abd1-d25e6f63628c",
    "type": "new-comment"
  }
]
```

### Delete an event

```
curl -X DELETE -H "Authorization: OIOzkfiZzrzrIIejj" \
http://localhost:8787/api/admin/event/<event-id>

{"message":"Event deleted"}
```

### List all comments for an article

It returns all comments for an article, approved or not.

```
curl -H "Authorization: OIOzkfiZzrzrIIejj" http://localhost:8787/api/admin/comment/<article-name>
```

### Approve a comment

Approves a comment for an article.

```
curl -X POST -H "Authorization: OIOzkfiZzrzrIIejj" \ http://localhost:8787/api/admin/comment/<article-name>/<comment-id>

{"message": "Comment approved"}
```

### Get a specific comment for an article

```
curl -H "Authorization: OIOzkfiZzrzrIIejj" \
http://localhost:8787/api/admin/comment/<article-name>/<comment-id>
```

### Delete a specific comment

```
curl -X DELETE -H "Authorization: OIOzkfiZzrzrIIejj" \
http://localhost:8787/api/admin/comment/<article-name>/<comment-id>
```

### Delete all comment for an article

```
curl -X DELETE -H "Authorization: OIOzkfiZzrzrIIejj" \
http://localhost:8787/api/admin/comment/<article-name>
```
